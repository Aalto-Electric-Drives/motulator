
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "drive_examples/flux_vector/plot_6kw_pmsyrm_sat_fvc.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_drive_examples_flux_vector_plot_6kw_pmsyrm_sat_fvc.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_drive_examples_flux_vector_plot_6kw_pmsyrm_sat_fvc.py:


5.6-kW saturated PM-SyRM, FVC
=============================

This example simulates sensorless flux-vector control (FVC) of a 5.6-kW permanent-magnet
synchronous reluctance machine (PM-SyRM, Baldor ECS101M0H7EF4) drive. The machine model
is parametrized using the flux map data, measured using the constant-speed test.

The control system is parametrized using an algebraic saturation model from [#Lel2024]_,
fitted to the measured data. For comparison, the measured data is plotted together with
the model predictions.

This example also demonstrates the mechanical-model-based speed observer [#Lor1991]_.
The lag of the speed estimate in accelerations is avoided, allowing to increase the
speed-control bandwidth. Using the mechanical-model-based speed observer is particularly
useful in the case of PM-SyRMs, where the speed-estimation bandwidth otherwise would be
limited due to the comparatively large q-axis inductance.

.. GENERATED FROM PYTHON SOURCE LINES 21-30

.. code-block:: Python


    from pathlib import Path

    import numpy as np
    from scipy.io import loadmat

    import motulator.drive.control.sm as control
    from motulator.drive import model, utils








.. GENERATED FROM PYTHON SOURCE LINES 31-32

Compute base values based on the nominal values (just for figures).

.. GENERATED FROM PYTHON SOURCE LINES 32-36

.. code-block:: Python


    nom = utils.NominalValues(U=460, I=8.8, f=60, P=5.6e3, tau=29.7)
    base = utils.BaseValues.from_nominal(nom, n_p=2)








.. GENERATED FROM PYTHON SOURCE LINES 37-39

Plot the saturation model (surfaces) and the measured flux map data (points). This
data is used to parametrize the machine model.

.. GENERATED FROM PYTHON SOURCE LINES 39-55

.. code-block:: Python


    # Load the measured data from the MATLAB file
    p = Path(__file__).resolve().parent if "__file__" in globals() else Path.cwd()
    meas_data = loadmat(p / "ABB_400rpm_map.mat")

    # Create the flux map from the measured data
    meas_flux_map = utils.MagneticModel(
        i_s_dq=meas_data["id_map"] + 1j * meas_data["iq_map"],
        psi_s_dq=meas_data["psid_map"] + 1j * meas_data["psiq_map"],
        type="flux_map",
    )

    # Plot the measured data
    # sphinx_gallery_thumbnail_number = 4
    utils.plot_flux_vs_current(meas_flux_map, base, x_lims=(-1.5, 1.5))




.. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_001.png
   :alt: plot 6kw pmsyrm sat fvc
   :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 56-57

Create a saturation model, which will be used in the control system.

.. GENERATED FROM PYTHON SOURCE LINES 57-75

.. code-block:: Python


    i_s_dq_fcn = utils.SaturationModelPMSyRM(
        a_d0=3.96,
        a_dd=28.5,
        S=4,
        a_q0=1.1 * 5.89,  # Unsaturated q-axis inductance is underestimated for robustness
        a_qq=2.67,
        T=6,
        a_dq=41.5,
        U=1,
        V=1,
        a_b=81.75,
        a_bp=1,
        k_q=0.1,
        psi_n=0.804,
        W=2,
    )








.. GENERATED FROM PYTHON SOURCE LINES 76-77

Compare the saturation model with the measured data.

.. GENERATED FROM PYTHON SOURCE LINES 77-103

.. code-block:: Python


    # Generate the flux map using the saturation model
    est_curr_map = i_s_dq_fcn.as_magnetic_model(
        d_range=np.linspace(-0.1 * base.psi, base.psi, 256),
        q_range=np.linspace(-1.4 * base.psi, 1.4 * base.psi, 256),
    )
    est_flux_map = est_curr_map.invert()

    # Plot the saturation model (surface) and the measured data (points)
    utils.plot_map(
        est_flux_map,
        "d",
        base,
        lims={"x": (-2, 2), "y": (-2, 2), "z": (0, 1)},
        ticks={"x": [-2, -1, 0, 1, 2], "y": [-2, -1, 0, 1, 2]},
        raw_data=meas_flux_map,
    )
    utils.plot_map(
        est_flux_map,
        "q",
        base,
        lims={"x": (-2, 2), "y": (-2, 2), "z": (-1.5, 1.5)},
        ticks={"x": [-2, -1, 0, 1, 2], "y": [-2, -1, 0, 1, 2]},
        raw_data=meas_flux_map,
    )




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_002.png
         :alt: plot 6kw pmsyrm sat fvc
         :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_002.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_003.png
         :alt: plot 6kw pmsyrm sat fvc
         :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_003.png
         :class: sphx-glr-multi-img





.. GENERATED FROM PYTHON SOURCE LINES 104-105

Configure the system model.

.. GENERATED FROM PYTHON SOURCE LINES 105-113

.. code-block:: Python


    meas_curr_map = meas_flux_map.invert()
    par = model.SaturatedSynchronousMachinePars(n_p=2, R_s=0.63, i_s_dq_fcn=meas_curr_map)
    machine = model.SynchronousMachine(par)
    mechanics = model.MechanicalSystem(J=0.05)
    converter = model.VoltageSourceConverter(u_dc=540)
    mdl = model.Drive(machine, mechanics, converter)








.. GENERATED FROM PYTHON SOURCE LINES 114-118

Configure the control system. Since the inertia estimate `J` is provided in
`FluxVectorControllerCfg`, the mechanical-model-based speed observer is used. Integral
action in flux-vector control is not needed (`alpha_i = 0`) since the speed observer's
load-torque disturbance estimation provides integral action.

.. GENERATED FROM PYTHON SOURCE LINES 118-129

.. code-block:: Python


    est_par = control.SaturatedSynchronousMachinePars(
        n_p=2, R_s=0.63, psi_s_dq_fcn=est_flux_map
    )
    cfg = control.FluxVectorControllerCfg(
        i_s_max=2 * base.i, J=0.05, alpha_i=0, alpha_o=2 * np.pi * 8
    )
    vector_ctrl = control.FluxVectorController(est_par, cfg, sensorless=True)
    speed_ctrl = control.SpeedController(J=0.05, alpha_s=2 * np.pi * 4)
    ctrl = control.VectorControlSystem(vector_ctrl, speed_ctrl)








.. GENERATED FROM PYTHON SOURCE LINES 130-131

Visualize the control loci.

.. GENERATED FROM PYTHON SOURCE LINES 131-139

.. code-block:: Python


    i_s_vals = [1, 2, 3]  # Current values for the plots
    mc = utils.MachineCharacteristics(est_par)
    mc.plot_flux_vs_torque(i_s_vals, base)
    mc.plot_current_vs_torque(i_s_vals, base)
    mc.plot_current_loci(i_s_vals, base)
    mc.plot_flux_loci(i_s_vals, base)




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_004.png
         :alt: plot 6kw pmsyrm sat fvc
         :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_004.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_005.png
         :alt: plot 6kw pmsyrm sat fvc
         :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_005.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_006.png
         :alt: plot 6kw pmsyrm sat fvc
         :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_006.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_007.png
         :alt: plot 6kw pmsyrm sat fvc
         :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_007.png
         :class: sphx-glr-multi-img





.. GENERATED FROM PYTHON SOURCE LINES 140-141

Set the speed reference and the external load torque.

.. GENERATED FROM PYTHON SOURCE LINES 141-145

.. code-block:: Python


    ctrl.set_speed_ref(lambda t: (t > 0.2) * 2 * base.w_M)
    mdl.mechanics.set_external_load_torque(lambda t: (t > 1.25) * 0.7 * nom.tau)








.. GENERATED FROM PYTHON SOURCE LINES 146-147

Create the simulation object, simulate, and plot the results in per-unit values.

.. GENERATED FROM PYTHON SOURCE LINES 147-152

.. code-block:: Python


    sim = model.Simulation(mdl, ctrl)
    res = sim.simulate(t_stop=2)
    utils.plot(res, base)




.. image-sg:: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_008.png
   :alt: plot 6kw pmsyrm sat fvc
   :srcset: /drive_examples/flux_vector/images/sphx_glr_plot_6kw_pmsyrm_sat_fvc_008.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 153-162

.. rubric:: References

.. [#Lel2024] Lelli, Hinkkanen, Giulii Capponi, "A saturation model based on a
   simplified equivalent magnetic circuit for permanent magnet machines," Proc. ICEM,
   2024, https://doi.org/10.1109/ICEM60801.2024.10700403

.. [#Lor1991] Lorenz, Van Patten, "High-resolution velocity estimation for
   all-digital, AC servo drives," IEEE Trans. Ind. Appl., 1991,
   https://doi.org/10.1109/28.85485


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 31.891 seconds)


.. _sphx_glr_download_drive_examples_flux_vector_plot_6kw_pmsyrm_sat_fvc.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_6kw_pmsyrm_sat_fvc.ipynb <plot_6kw_pmsyrm_sat_fvc.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_6kw_pmsyrm_sat_fvc.py <plot_6kw_pmsyrm_sat_fvc.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_6kw_pmsyrm_sat_fvc.zip <plot_6kw_pmsyrm_sat_fvc.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
